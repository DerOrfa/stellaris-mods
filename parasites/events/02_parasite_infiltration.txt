###############################################################
# Events for parasite infiltration parasite.xx + parasite.200 #
###############################################################

namespace = parasite

#a talented science leader is generated by the station
# bug will sometimes not show up in the leader screen untill you opened that twice
ship_event = {
	id = parasite.20
	hide_window = yes
	
	trigger = {
		is_ship_class = shipclass_research_station
		orbit = { has_planet_flag = parasite_temple }
	}
	
	mean_time_to_happen = { 
		months = @PARASITE_TALENT_MTTH_MONTHS 
		modifier = { # reduce rate after first trigger
				factor = 5
				has_ship_flag = talent_triggered
		}
	}
	immediate = { 
		ship_event = { id = parasite.30 days = 15 random = 15 } 	#start timer for extending station after first created leader
		ship_event = { id = parasite.22 }
		set_ship_flag = talent_triggered
	}
}
ship_event = {
	id = parasite.22
	is_triggered_only = yes
	title = "anomaly.4055.name"
	desc = "parasite.22.desc"
	picture = GFX_evt_physics_research
	show_sound = event_laboratory_sound
	location = this
	
	trigger = { # only if we still use the station as a science station
		owner = { NOT = { has_policy_flag = parasite_station_education_full } }
	}
	
	immediate = { owner = { save_event_target_as = parasite_country } } #needed for make_leader_parasite below

	option = {
		name = parasite.22.a
		owner = {
			create_leader = {
				class = scientist
				species = owner_main_species
				name = random
				skill = 3
				leader_age_min = 20
				leader_age_max = 30
				effect = {
					make_leader_parasite = yes
				}
			}
		}
	}
	option = {
		name = anomaly.4055.b
		hidden_effect = {
			#todo add some effect
		}
	}
}

# event to extend station (this will make all new leaders parasite leaders)
ship_event = {
	id = parasite.30
	is_triggered_only = yes
	fire_only_once = yes
	hide_window = yes

	immediate = { 
		owner = { country_event = { id = parasite.32 } }
	}
}
country_event = {
	id = parasite.32
	is_triggered_only = yes
	title = "parasite.32.name"
	desc = "parasite.32.desc"
	picture = GFX_evt_physics_research
	show_sound = event_laboratory_sound
	location = FROM
	fire_only_once = yes
	
	immediate = {
		set_country_flag = parasite_station_extended #open option to educate leaders on the station
	}
	
	option = {
		name = parasite.32.a
		custom_tooltip = parasite.32.a.desc
		ai_chance = {
			factor = 150
			modifier = {
				factor = 4
				has_ethic = ethic_authoritarian
			}
			modifier = {
				factor = 8
				has_ethic = ethic_fanatic_authoritarian
			}
		}
		set_policy = {
			policy = parasite_station
			option = parasite_station_education_full
			cooldown = yes
		}

	}
	option = {
		name = parasite.32.b
		ai_chance = {
			factor = 100
			modifier = {
				factor = 4
				has_ethic = ethic_egalitarian
			}
			modifier = {
				factor = 8
				has_ethic = ethic_fanatic_egalitarian
			}
		}
	}
	option = {
		name = parasite.32.c
		FROM = { orbit = {
			remove_deposit = ancient_lotus_temple 
			remove_planet_flag = parasite_temple
		} }
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				has_ethic = ethic_egalitarian
			}
			modifier = {
				factor = 4
				has_ethic = ethic_fanatic_egalitarian
			} 
			modifier = {
				factor = 0.75
				OR = { 
					has_ethic = ethic_authoritarian 
					has_ethic = ethic_xenophile
				}
			}
			modifier = {
				factor = 0.5
				OR = {
					has_ethic = ethic_fanatic_authoritarian 
					has_ethic = ethic_fanatic_xenophile
				}
			}
			modifier = {
				factor = 5
				has_ethic = ethic_xenophobe
			}
			modifier = {
				factor = 10
				has_ethic = ethic_fanatic_xenophobe
			}
		}
	}
}

## if we centralized our education under the influence of the parasite temple

# if a leader was created the normal way - change him to be a parasite leader
# scope: country, from: leader
country_event = {
	id = parasite.40
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		has_policy_flag = parasite_station_education_full
	}

	immediate = {
		save_event_target_as = parasite_country #needed for make_leader_parasite below
		FROM = { make_leader_parasite = yes }
	}
}

#make non-parasite leaders have "accidents"
country_event = {
	id = parasite.50
	hide_window = yes
	
	mean_time_to_happen = { 
		months = @PARASITE_ASN_MTTH_MONTHS 
		modifier = { # much less likely if is parasite station is just for research
				factor = 8
				NOT = { has_policy_flag = parasite_station_education_full }
		}
		modifier = { # reduce rate after speciation
			factor = 2
			has_country_flag = parasite_speciation_1
		}

	}

	trigger = {
		has_country_flag = parasite_station_extended
	}

	immediate = {
		random_list = { 
			75 = {
				modifier = { #skip if there are no non-parasite leaders in the pool anymore
					factor = 0
					count_pool_leader = { limit = { is_parasite_leader = no } count < 1 }
				}
				random_pool_leader = {
					limit = { is_parasite_leader = no }
					save_event_target_as = accident_leader
					random_list = { 
						50 = { #leader is killed
							log = "Assassination attempt on pooled [This.GetName] from [Root.GetName] succeded"
							kill_leader = { show_notification = no }
						} 
						25 = { #survives and becomes shaken 
							log = "Assassination attempt on pooled [This.GetName] from [Root.GetName] made shaken"
							make_leader_shaken = yes
						} 
						25 = { #survives
							log = "Assassination attempt on pooled [This.GetName] from [Root.GetName] failed"
						} 
					}
				}
			}
			25 ={
				random_owned_leader = {
					limit = { is_parasite_leader = no }
					weights = {
						base = 10
						modifier = { # rulers are better protected
							mult = 0.5
							leader_class = ruler
						}
					}
					save_event_target_as = accident_leader
					log = "Assassination attempt on owned [This.GetName] from [Root.GetName]"
					random_list = { 
						33 = { #leader is killed
							owner = { country_event = { id=parasite.60 } } #kill'n'tell
						} 
						33 = { #survives and becomes shaken
							owner = { country_event = { id=parasite.65 } } #not-kill'n'tell
						} 
						33 = { #survives
							log = "Assassination attempt on owned [This.GetName] from [Root.GetName] failed"
						} 
					}
				}
			}
		}
	}
}

#kill'n'tell
country_event = { 
	id = parasite.60
	is_triggered_only = yes
	title = "parasite.60.name"
	picture = GFX_evt_exploding_ship
	show_sound = event_ship_explosion

	immediate = {
		event_target:accident_leader = { replace_leader = yes }
	}

	desc = {
		trigger = { NOT = { exists = event_target:assignment } }
		text = "parasite.60.noassignment"
	}	
	desc = {
		trigger = { exists = event_target:assignment }
		text = "parasite.60.assignment"
	}
	
	#replacement exists and we want that
	option = {
		name = "parasite.60.a"
		trigger = { exists = event_target:assignment }
		event_target:accident_leader = { kill_leader = { show_notification = no } }
		
		custom_tooltip = "parasite.60.a.desc"

		activate_saved_leader = {
			key = replacement
			effect = {
				make_leader_parasite = yes
				event_target:assignment = {
					assign_leader = PREV
				}
			}
		}
	}
	#replacement rejected
	option = {
		name =  "parasite.60.b"
		trigger = { exists = event_target:assignment }
		
		event_target:accident_leader = { kill_leader = { show_notification = no } }

		if = { limit = { exists = event_target:assignment}		
			remove_saved_leader = replacement
		}
	}
	#replacement not available
	option = {
		name =  TERRIBLE
		trigger = { NOT = { exists = event_target:assignment } }
		
		event_target:accident_leader = { kill_leader = { show_notification = no } }

		if = { limit = { exists = event_target:assignment}		
			remove_saved_leader = replacement
		}
	}
}

#not-kill'n'tell
country_event = { 
	id = parasite.65
	is_triggered_only = yes
	title = "parasite.65.name"
	desc = "parasite.65.desc"
	picture = GFX_evt_exploding_ship
	show_sound = event_ship_explosion

	option = {
		name = WORRYING
		event_target:accident_leader = { make_leader_shaken = yes }
	}
}

# parasite leader became ruler
country_event = {
	id = parasite.200
	is_triggered_only = yes
	hide_window = yes
	
	trigger = { 
		exists = ruler
		ruler = {
			is_parasite_leader = yes
		}
	}
	
} 

