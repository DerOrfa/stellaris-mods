namespace = parasite

# initialize parasite event chain on mars (aka the only terraforming candidate  in sol)
country_event = {
	id = parasite.1
	hide_window = yes
	fire_only_once = yes 
	is_triggered_only = yes
	
	trigger = {
		NOR = {
			is_hive_empire = yes
			is_machine_empire = yes
		}
	}
	
	immediate = {
		random_system_within_border = {
			limit = { has_star_flag = sol_system }
			random_system_planet = {
				limit = {
					OR = {
						has_modifier = terraforming_candidate
						has_planet_flag = martiancolony # compatibility with mod "colony on mars"
					}
				} 
				save_event_target_as = parasite_planet
				#clear any station around the planet
				FROMFROM = { 
					every_owned_ship = {
						limit = { 
							exists = orbit 
							is_ship_class = shipclass_mining_station
							orbit = { is_same_value = event_target:parasite_planet }
						}
						orbit = { log = "Removing [Prev.GetName] orbiting [This.GetName] to make place for lotus station" }
						delete_ship = This
					}
				}
				FROMFROM = { country_event = { id = parasite.2 days = 3 random = 1 } }
			}	
		}
		
	}
}

# parasite temple discovered creates temple and special project
country_event = {
	id = parasite.2
	is_triggered_only = yes
	fire_only_once = yes 

	title = "parasite.2.name"
	desc = "parasite.2.desc"
	picture = GFX_evt_alien_nature
	show_sound = event_alien_nature
	location = event_target:parasite_planet

	option = {
		name = CURIOUS
		hidden_effect = { 
			event_target:parasite_planet = {
				set_planet_flag = parasite_temple
			}
		}
		enable_special_project = {
			name = "PARASITE_TEMPLE_INVESTIGATE"
			location = event_target:parasite_planet
			owner = this
		}

	}
	option = {
		name = NOTIME
	}
}

# entered temple
ship_event = {
	id = parasite.5
	is_triggered_only = yes
	fire_only_once = yes 
	
	title = "parasite.5.name"
	desc = "parasite.5.desc"
	picture = GFX_evt_big_landing_ship
	show_sound = event_alien_nature
	location = this

	option = {
		name = parasite.5.a
		custom_tooltip = parasite.5.a.desc

		hidden_effect = {
			event_target:parasite_planet = {
				clear_deposits = yes
				add_deposit = ancient_lotus_temple_station
			}
			ship_event = { id = parasite.6 days = 4 random = 1 } 
		}
	}
	option = {
		name = parasite.5.b
		custom_tooltip = parasite.5.b.desc
	}
}
#returned from the temple
ship_event = {
	id = parasite.6
	is_triggered_only = yes
	fire_only_once = yes 
	
	title = "parasite.6.name"
	desc = "parasite.6.desc" #todo have a different text when research station is already there
	picture = GFX_evt_big_landing_ship
	show_sound = event_alien_nature
	location = this

	option = {
		name = EXCELLENT
		leader = { 
			set_timed_leader_flag = { flag = has_gained_level_trait days = 20 }
			add_experience = 500
			add_trait = leader_trait_expertise_statecraft 
			add_ruler_trait = trait_ruler_charismatic
			add_trait = leader_trait_resilient 
			set_leader_flag = parasite_leader
			
			create_species = {
				name = "lotus_touched.name"
				plural = "lotus_touched.plural"
				class = this
				portrait = this
				traits = {
					trait="trait_decadent"
					trait="trait_intelligent"
					trait="trait_charismatic"
					trait="trait_natural_sociologists"
				}
				homeworld = home_planet
			}
			last_created_species = { 
				save_event_target_as = lotus_touched_species 
				set_species_flag = parasite_speciation_1
			}
		}
		hidden_effect = {
			owner = { 
				country_event = { id = parasite.300 days = @PARASITE_SPECIATION1_TIME random = @PARASITE_SPECIATION1_RND } #start timer for speciation
			} 
		}
	}
}

# first speciation
country_event = {
	id = parasite.300
	is_triggered_only = yes
	fire_only_once = yes 
	
	title = "parasite.300.name"
	desc = "parasite.300.desc"
	picture = GFX_evt_alien_propaganda
	show_sound = event_mystic_reveal
	#event_public_unrest
	
	immediate = {
		set_country_flag = parasite_speciation_1
	}

	option = {
		name = FASCINATING
		#reveal all leaders
		every_owned_leader = {
			limit = { has_leader_flag = parasite_leader }
			change_species = event_target:lotus_touched_species
			remove_leader_flag = parasite_leader #this is not needed anymore
		}
		every_pool_leader = {
			limit = { has_leader_flag = parasite_leader }
			change_species = event_target:lotus_touched_species
			remove_leader_flag = parasite_leader #this is not needed anymore
		}
		
		#"reveal" pops on planets
		every_owned_planet = { 
			# if the governor is parasite he has put parasites in strategic positions
			if = { 
				limit = {
					sector = {
						exists = leader
						leader = { is_parasite_leader = yes }
					}
				}
				every_owned_pop = {
					limit = {
						OR = {
							is_pop_category = ruler
							has_job = enforcer
						}
						planet = { is_same_value = PREVPREV }
					}
					change_species = event_target:lotus_touched_species
					hidden_effect = { pop_change_ethic = ethic_authoritarian }
				}
			}
			else = { # otherwise its a bit random
				random_pop = {
					limit = {
						is_pop_category = ruler
					}
					change_species = event_target:lotus_touched_species
					hidden_effect = { pop_change_ethic = ethic_authoritarian }
				}
				random_pop = {
					limit = {
						is_pop_category = specialist
					}
					change_species = event_target:lotus_touched_species
					hidden_effect = { pop_change_ethic = ethic_authoritarian }
				}
			}
		}
	}
}

# planet has been terraformed 
# From = Terraforming country
planet_event = {
	id = parasite.900
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		has_planet_flag = parasite_temple
	}
	immediate = { 
		add_deposit = ancient_lotus_temple
	}
}

